@startuml "Class Diagram"

skinparam linetype ortho

' --- Data Layer ---
class "IdentityDbContext<TUser>" as IdentityDbContext <<framework>>
class IdentityUser <<framework>>

class AuthProviderDbContext {
    +AuthProviderDbContext(DbContextOptions<AuthProviderDbContext>)
}

class ApplicationUser

IdentityDbContext <|-- AuthProviderDbContext
IdentityUser <|-- ApplicationUser
AuthProviderDbContext "1" --> "*" ApplicationUser : manages >

' --- Controllers ---
class Controller <<framework>>

class AuthorizationController {
    - _applicationManager: IOpenIddictApplicationManager {readOnly}
    - _authorizationManager: IOpenIddictAuthorizationManager {readOnly}
    - _scopeManager: IOpenIddictScopeManager {readOnly}
    - _signInManager: SignInManager<ApplicationUser> {readOnly}
    - _userManager: UserManager<ApplicationUser> {readOnly}

    +Authorize(): Task<IActionResult>
    +Accept(): Task<IActionResult>
    +Deny(): IActionResult
    +Logout(): IActionResult
    +LogoutPost(): Task<IActionResult>
    +Exchange(): Task<IActionResult>
    -CreateIdentityWithClaims(ApplicationUser, ClaimsPrincipal?): Task<ClaimsIdentity>
    -MustForceAuthentication(OpenIddictRequest?, AuthenticateResult?): bool
}

class HomeController {
    +Index(): IActionResult
    +Error(): IActionResult
}

Controller <|-- AuthorizationController
Controller <|-- HomeController

HomeController ..> ErrorViewModel
AuthorizationController ..> AuthorizeViewModel

' --- Models & ViewModels ---
class AuthorizeViewModel <<ViewModel>> {
    +ApplicationName: string?
    +Scope: string?
}

class ErrorViewModel <<ViewModel>> {
    +RequestId: string?
    +ShowRequestId: bool {readOnly}
}

' --- Identity Pages ---
class PageModel <<framework>>

' --- Login Model ---
class LoginModel {
    +Input: LoginInputModel
    +ErrorMessage: string
    - _signInManager: SignInManager<ApplicationUser> {readOnly}

    +OnGetAsync(string): Task
    +OnPostAsync(string): Task<IActionResult>
}

class LoginInputModel {
    +Email: string
    +Password: string
    +RememberMe: bool
}

LoginModel +-- LoginInputModel
PageModel <|-- LoginModel


' --- Register Model ---
class RegisterModel {
    - _signInManager: SignInManager<ApplicationUser>
    - _userManager: UserManager<ApplicationUser>
    - _userStore: IUserStore<ApplicationUser>
    - _emailStore: IUserEmailStore<ApplicationUser>
    - _emailSender: IEmailSender

    +Input: RegisterInputModel
    +ReturnUrl: string

    +OnGetAsync(string): Task
    +OnPostAsync(string): Task<IActionResult>
    -CreateUser(): ApplicationUser
}

class RegisterInputModel {
    +Email: string
    +Password: string
    +ConfirmPassword: string
}

RegisterModel +-- RegisterInputModel
PageModel <|-- RegisterModel

' --- Index Model ---
class IndexModel {
    - _userManager: UserManager<ApplicationUser> {readOnly}
    - _signInManager: SignInManager<ApplicationUser> {readOnly}

    +Input: IndexInputModel
    +Username: string
    +StatusMessage: string
    +OnGetAsync(): Task<IActionResult>
    +OnPostAsync(): Task<IActionResult>
    -LoadAsync(ApplicationUser): Task
}

class IndexInputModel {
    +PhoneNumber: string
}

IndexModel +-- IndexInputModel
PageModel <|-- IndexModel

@enduml
